# 前提ルール（MVP）— 書籍FAX受注（パターンA：下書き生成・確認モデル）

本ドキュメントは、DB設計（DDL/ER）を成立させるための「前提ルール」をまとめる。

---

## 1. 目的と基本方針

- システムは「自動確定」より **人間の確認・確定を中心**に置く（パターンA）。
- 外部APIやOCRが不安定でも **処理を止めない**（下書き提示を継続）。
- DBは業務データ中心。ログ（APIレスポンス全文等）で肥大化しない。
- 正規化・名寄せは **MVPでは最小限**（ISBN中心、出版社はマスタ＋別名）。

---

## 2. ストレージと原本管理

### 2.1 `fax_jobs.original_storage_path`
- `original_storage_path` は **URLではなくストレージ上の相対パス（またはファイル名）** を入れる。
- 保存先（バケット/フォルダ構造）はアプリ側の暗黙知でよい。
- 例:
  - `fax/2026/02/abc123.pdf`
  - `abc123.pdf`（ファイル名のみ運用も可）

### 2.2 原本は改変しない
- 原本（PDF/画像）は **読み取り専用**として扱い、後から差し替えない。
- 再取り込みが必要なら新しい `fax_jobs` として扱う（または audit_logs で差し替えを明示）。

---

## 3. OCR実行ルール（job単位）

### 3.1 OCRは「注文書（PDF）単位」で実行する
- 1 `fax_job` につき OCRは複数回実行してよい（回転補正、エンジン変更など）。
- OCR結果は `ocr_runs` に蓄積する。

### 3.2 採用OCR（selected）
- 採用するOCR runは、`ocr_runs.is_selected = true` を **原則1件**にする（運用で担保）。
- 採用したOCR runは `fax_jobs.selected_ocr_run_id` で参照する。
- `fax_jobs.ocr_text_summary / isbn*` は「採用OCRの要約」を反映する（キャッシュ扱い）。

### 3.3 ISBN正規化
- OCRから得たISBNは以下を適用して正規化する。
  - ハイフン/空白/全角数字の混入を除去 → **数字のみ**にする
  - 10桁/13桁を判定し、可能なら13桁へ寄せる（運用方針で決める）
- `isbn13_normalized` は **検索・照合・重複検知** のためのキーとして使う。

---

## 4. API照合ルール（軽量ログ）

### 4.1 フォールバック（冗長化）
- API照合は `PRIMARY → SECONDARY → TERTIARY` の順で試行してよい。
- すべて失敗しても処理を止めず、OCR情報だけで下書きを提示する。

### 4.2 `api_lookup_logs` の保存方針（要約のみ）
- DBには **再現に必要な最小情報＋要約**のみ保存する。
- 保存するもの:
  - `provider_name`（openBD等）
  - `request_mode`（ISBN / TITLE_AUTHOR）
  - `request_key`（検索キー）
  - `result_count`
  - `best_*`（採用候補の要点）
  - `success/http_status/error/latency`
- APIレスポンス全文は保存しない（必要なら別途ログ基盤に出す）。

### 4.3 request_keyの形式（例）
- ISBN検索:
  - `isbn13:978XXXXXXXXXXXXX`
- タイトル・著者検索:
  - `title:<TITLE>|author:<AUTHOR>`
- 可能ならアプリ側で正規化した文字列を使う（空白除去等は実装側で統一）。

---

## 5. トリアージ（INFO/WARN/ERROR）の前提

### 5.1 triage の意味
- `INFO`：自動確定可能レベル（ただし最終確定は人間が行ってもよい）
- `WARN`：人間確認必須（候補複数、情報不一致など）
- `ERROR`：人間修正必須（ISBNチェックサムNG、数量欠落など）

### 5.2 triage_reasons の扱い（例）
- `triage_reasons` は「なぜその判定になったか」を示す **短いコード配列**。
- 例（候補）:
  - `ISBN_CHECKSUM_NG`
  - `API_ZERO_HIT`
  - `MULTIPLE_CANDIDATES`
  - `TITLE_MISMATCH`
  - `AUTHOR_MISMATCH`
  - `REQUIRED_FIELD_MISSING_QUANTITY`

---

## 6. 出版社マスタと名寄せの前提

### 6.1 PUBLISHERS の役割
- `publishers` は **正規名称（name）と一意ID**を管理する。
- `publishers.name` の重複は関数ユニークインデックスで防ぐ（lower/trim）。

### 6.2 PUBLISHER_ALIASES の役割
- `publisher_aliases` は、APIやOCRなど外部入力で得られる **出版社表記ゆれ**を登録する。
- `alias` の重複も関数ユニークインデックスで防ぐ（lower/trim）。
- 名寄せの基本方針:
  - 外部文字列 → alias検索 → 見つかれば publisher_id を採用
  - 見つからなければ、人間が alias を追加する（運用で回す）

### 6.3 PUBLISHER_ROUTES（注文方法）
- 出版社ごとの発注方法は `publisher_routes.order_method`（WEB/FAX/BOTH/UNKNOWN）で **明示**する。
- `web_order_url` / `fax_number` は補助情報（未登録でも order_method は決められる）。
- `order_instructions` に手順（コピペ先URL、ログイン要否、注意事項）を自由記述できる。

---

## 7. 受注台帳（orders / order_lines）の前提

### 7.1 orders は確定後のデータ
- `orders` / `order_lines` は **人間が確定した後**の正式データ。
- `orders.fax_job_id` により、元FAX（job）と1対1で紐づく。

### 7.2 customers の扱い
- `customers` は顧客（店）のマスタ。
- `orders.customer_id` は必須（顧客を必ず特定してから確定する）。

### 7.3 selected_api_lookup_log_id（参照で残す）
- ISBNなしの曖昧検索などで候補を採用した場合は、
  - `order_lines.selected_api_lookup_log_id` に採用ログを紐づける。
- JSONで候補全文を保持しない（DB肥大化防止）。

---

## 8. 状態遷移の前提（ざっくり）

- `RECEIVED`（受付）  
  → OCR実行  
- `OCR_DONE`（OCR完了）  
  → API照合・トリアージ  
- `TRIAGED`（トリアージ完了）  
  → `NEED_REVIEW`（確認待ち） or `HELD`（保留）
- `NEED_REVIEW`（人間確認）  
  → `CONFIRMED`（確定）
- `CONFIRMED`（確定）  
  → `ORDERING` → `PICKING` → `SHIPPED` → `CLOSED`
- 例外:
  - 判読不能: `UNREADABLE`
  - 差戻し/拒否: `REJECTED`
  - キャンセル: `CANCELED`

※ 状態の厳密な遷移制約（どこからどこへ遷移可能か）は、MVPではアプリ側実装で担保する。

---

## 9. 監査（audit_logs）の前提

- 監査は「何が起きたか」をテキストで残す（JSON差分は持たない）。
- 少なくとも以下はログ化する:
  - 確定操作（fax_job → order 作成）
  - 出版社ルート/別名の追加・更新
  - WARN/ERROR の修正内容