# 要件定義（MVP）まとめ：修正版

対象：書籍注文（パターンA：下書き生成・人間確定モデル）
方針：AIは下書き生成・トリアージまで。最終確定は必ず人間が行う。

## 1. 基本思想（MVP方針）

- AIは「最強の下書き」と「要注意箇所の可視化」まで行う。
- 自動確定は行わない（INFOも必ず人間確認を経由）。
- API全滅時も処理は停止しない（OCR結果を下書き提示）。
- データ品質を最優先とし、人間の心理的安心感を重視する。
- 外部発注はMVPでは手動（自動発注はフェーズ2）。

## 2. 機能一覧（MVP）

### 2.1 Must（必須）

| カテゴリ | 機能 | 概要 |
|----------|------|------|
| 取込 | FAX画像取込 | 画像/PDF登録、受信ジョブ生成 |
| OCR | OCR実行 | ISBN/書名/著者/数量抽出 |
| 解析 | ISBN正規化 | ハイフン除去・数字のみ抽出・チェックデジット検証 |
| 解析 | 書誌API照合（Primary） | ISBN優先、ISBNなしはタイトル/著者検索 |
| 解析 | トリアージ判定 | INFO/WARN/ERROR判定＋理由保存 |
| UI | 受信一覧 | トリアージ別表示、検索、絞込 |
| UI | 確認・確定画面（S2統合型） | 原本/OCR/API並列表示＋差分ハイライト＋修正＋確定 |
| UI | ワンクリックコピー | ISBN（必須）、書名・著者（推奨） |
| 台帳 | 受注登録 | 確定でorders/order_linesへ保存 |
| マスタ | 出版社ルート参照 | Web/FAX判定 |
| マスタ | 出版社管理 | CRUD |
| マスタ | 出版社エイリアス（名寄せ） | 表記ゆれ→正規publisher紐付け |
| 出荷 | ピッキングリスト出力 | 確定済データから生成 |
| 状態 | ステータス管理 | CONFIRMED→ORDERING→PICKING→SHIPPED→CLOSED |
| 保留 | HELD状態 | 確認中・問い合わせ中の一時保留 |
| 監査 | 監査ログ | 受信/解析/修正/確定/状態遷移保存 |
| 保管 | アーカイブ | 原本＋APIログ＋修正履歴保存 |

----------------------------------------------------

### 2.2 Should（優先度高・次段階）

- Secondary APIフォールバック
- INFO一括確定ボタン
- 再検索ボタン
- 再OCR機能
- 発注メモ欄
- 再解析機能

----------------------------------------------------

### 2.3 Could（フェーズ2）

- FAX直接送信ボタン
- Web発注自動化（RPA）
- AIバーコード検品
- 請求書自動送付
- キャンセル完全自動連動

## 3. トリアージ定義

INFO  

- ISBN一致＋タイトル一致（許容範囲内）
- 自動確定は行わない
- 一括確定対象

WARN  

- タイトル類似
- 著者不一致
- API間不一致
- 候補複数

ERROR  

- ISBNチェックサムNG
- APIヒット0件
- 必須項目欠落（数量なし等）

## 4. 状態遷移設計

受信ジョブ（fax_job）

RECEIVED
→ OCR_DONE
→ TRIAGED(INFO/WARN/ERROR)
→ NEED_REVIEW
→ CONFIRMED
→ ORDERING
→ PICKING
→ SHIPPED
→ CLOSED

補助状態：

- HELD（問い合わせ中・確認中）
- UNREADABLE（白紙・判読不能）
- CANCELED（途中キャンセル）
- REJECTED（破棄）

※ INFOも必ずNEED_REVIEWを経由する

## 5. 画面構成（MVP）

S1：受信一覧

- トリアージ色分け表示
- 検索・絞込

S2：確認・確定（S4統合）

- 原本/OCR/API三者比較
- 差分ハイライト
- 候補選択
- 修正入力
- ワンクリックコピー
- 発注ルート表示
- 確定ボタン
- 状態変更（ORDERING等）

S3：受注一覧

- 確定済管理
- 状態更新

S4：出版社マスタ管理

- 出版社登録
- ルート設定（Web/FAX）
- エイリアス登録

## 6. 非機能（MVP最小）

- API失敗時も処理停止しない
- OCR/照合処理はタイムアウト管理
- 原本は一定期間保存（例：3年以上）
- 監査ログは削除不可

## 7. 将来拡張コメント

- INFO自動確定機能はフェーズ2で設定可能にする
- Web発注自動化は十分な安定後に検討
- 検品AIは運用データ蓄積後に導入
